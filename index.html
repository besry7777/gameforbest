<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>บ้านนอกเข้ากรุงลีก - ตารางคะแนน</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Kanit', sans-serif; 
      -webkit-tap-highlight-color: transparent; 
      touch-action: pan-y;
      overscroll-behavior: none;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
    }
    
    .screen { 
      display: none; 
      min-height: 100vh;
    }
    .screen.active { display: flex; }
    
    .team-badge {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 0.75rem;
      color: white;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .team-badge::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
    }
    
    .table-row {
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    
    .table-row:active {
      background-color: rgba(34, 211, 238, 0.1);
      transform: scale(0.98);
    }
    
    .table-row.rank-1 {
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, transparent 100%);
      border-left-color: #22c55e;
    }
    
    .table-row.rank-2 {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.12) 0%, transparent 100%);
      border-left-color: #3b82f6;
    }
    
    .table-row.rank-3 {
      background: linear-gradient(90deg, rgba(249, 115, 22, 0.12) 0%, transparent 100%);
      border-left-color: #f97316;
    }
    
    .button {
      @apply px-6 py-3 rounded-xl font-semibold text-white transition-all duration-200;
      position: relative;
      overflow: hidden;
    }
    
    .button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.5s, height 0.5s;
    }
    
    .button:active::before {
      width: 300px;
      height: 300px;
    }
    
    .button:active {
      transform: scale(0.95);
    }
    
    .button-primary {
      background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
      box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
    }
    
    .button-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }
    
    .button-secondary {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      box-shadow: 0 4px 15px rgba(100, 116, 139, 0.4);
    }
    
    .button-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }
    
    .match-card {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border: 2px solid #334155;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .match-card:active {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    .match-card.completed {
      border-color: #22d3ee;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }
    
    .loader-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(10px);
    }
    
    .loader-overlay.active {
      display: flex;
    }
    
    .loader {
      border: 6px solid #334155;
      border-top: 6px solid #22d3ee;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .input-field {
      @apply w-full px-4 py-3 bg-slate-700 text-white border-2 border-slate-600 rounded-xl focus:outline-none focus:border-cyan-400 transition-all;
    }
    
    .input-field:focus {
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
    }
    
    .admin-section {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #334155;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .page-title {
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 40px rgba(168, 85, 247, 0.4);
    }
    
    .trophy-icon {
      animation: bounce 2s infinite;
      color: #f59e0b; /* สีทอง */
      text-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .menu-card {
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
      border: 2px solid rgba(34, 211, 238, 0.3);
      border-radius: 20px;
      padding: 24px;
      margin: 12px 0;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .menu-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }
    
    .menu-card:active::before {
      left: 100%;
    }
    
    .menu-card:active {
      transform: scale(0.95);
      border-color: #22d3ee;
      box-shadow: 0 0 30px rgba(34, 211, 238, 0.3);
    }
    
    .stats-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    .score-display {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #22d3ee 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>
</head>
<body class="text-gray-100 min-h-screen">

  <div id="loading-overlay" class="loader-overlay">
    <div class="flex flex-col items-center">
      <div class="loader"></div>
      <p class="mt-4 text-cyan-400 font-semibold">กำลังโหลด...</p>
    </div>
  </div>

  <main id="app-container" class="w-full min-h-screen pb-20">
    
        <div id="main-menu" class="screen active flex-col items-center justify-center p-5">
      <div class="text-center mb-12">
        <div class="trophy-icon text-6xl mb-4">🏆</div>
        <h1 class="text-6xl font-extrabold mb-3 page-title">
          บ้านนอกเข้ากรุงลีก
        </h1>
        <p class="text-slate-300 text-xl font-semibold">ฤดูกาล 2025</p>
        <div class="mt-2 flex items-center justify-center gap-2">
          <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
          <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse delay-100"></div>
          <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse delay-200"></div>
        </div>
      </div>
      
      <div class="w-full max-w-md space-y-4">
        <button id="view-table-btn" class="menu-card w-full">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-2xl flex items-center justify-center text-2xl shadow-lg">
              📊
            </div>
            <div class="flex-1 text-left">
              <h3 class="text-xl font-bold text-white">ดูตารางคะแนน</h3>
              <p class="text-sm text-slate-300">อันดับทีมและสถิติ</p>
            </div>
            <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        </button>
        
        <button id="view-fixtures-btn" class="menu-card w-full">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-gradient-to-br from-emerald-500 to-green-500 rounded-2xl flex items-center justify-center text-2xl shadow-lg">
              📅
            </div>
            <div class="flex-1 text-left">
              <h3 class="text-xl font-bold text-white">ตารางการแข่งขัน</h3>
              <p class="text-sm text-slate-300">ดูผลการแข่งทั้งหมด</p>
            </div>
            <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        </button>
        
        <button id="admin-panel-btn" class="menu-card w-full">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center text-2xl shadow-lg">
              ⚙️
            </div>
            <div class="flex-1 text-left">
              <h3 class="text-xl font-bold text-white">จัดการผลการแข่งขัน</h3>
              <p class="text-sm text-slate-300">บันทึกผลและจัดการข้อมูล</p>
            </div>
            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        </button>
      </div>
      
      <div class="mt-12 text-center">
        <p class="text-slate-400 text-sm">Made with ❤️ for Football Fans</p>
      </div>
    </div>

        <div id="table-screen" class="screen flex-col p-5">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-slate-900/95 backdrop-blur-lg py-4 px-2 rounded-2xl z-10">
        <button id="back-from-table" class="text-cyan-400 flex items-center gap-2 font-semibold">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          กลับ
        </button>
        <h2 class="text-2xl font-bold">🏆 ตารางคะแนน</h2>
        <div class="w-16"></div>
      </div>
      
      <div class="glass-card overflow-hidden">
        <div class="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 px-4 py-4 grid grid-cols-12 gap-2 text-xs font-bold border-b border-cyan-500/30">
          <div class="col-span-1 text-cyan-400">#</div>
          <div class="col-span-5 text-cyan-400">ทีม</div>
          <div class="col-span-1 text-center text-slate-300">M</div>
          <div class="col-span-1 text-center text-green-400">W</div>
          <div class="col-span-1 text-center text-yellow-400">D</div>
          <div class="col-span-1 text-center text-rose-400">L</div>
          <div class="col-span-2 text-center text-cyan-400">PTS</div>
        </div>
        
        <div id="league-table-body" class="divide-y divide-slate-700/50">
                  </div>
      </div>
      
      <div class="mt-6 glass-card p-4">
        <h3 class="font-semibold text-slate-300 mb-3 flex items-center gap-2">
          <span>📝</span> หมายเหตุ
        </h3>
        <div class="space-y-2 text-sm text-slate-400">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-green-500 rounded"></div>
            <span>อันดับ 1 - แชมป์</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-blue-500 rounded"></div>
            <span>อันดับ 2 - รองแชมป์</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-orange-500 rounded"></div>
            <span>อันดับ 3</span>
          </div>
        </div>
      </div>
    </div>

        <div id="fixtures-screen" class="screen flex-col p-5">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-slate-900/95 backdrop-blur-lg py-4 px-2 rounded-2xl z-10">
        <button id="back-from-fixtures" class="text-cyan-400 flex items-center gap-2 font-semibold">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          กลับ
        </button>
        <h2 class="text-2xl font-bold">📅 ผลการแข่งขัน</h2>
        <div class="w-16"></div>
      </div>
      
      <div id="fixtures-container" class="space-y-3">
              </div>
    </div>

        <div id="admin-screen" class="screen flex-col p-5">
      <div class="flex items-center justify-between mb-6 sticky top-0 bg-slate-900/95 backdrop-blur-lg py-4 px-2 rounded-2xl z-10">
        <button id="back-from-admin" class="text-cyan-400 flex items-center gap-2 font-semibold">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          กลับ
        </button>
        <h2 class="text-2xl font-bold">⚙️ จัดการข้อมูล</h2>
        <div class="w-16"></div>
      </div>

      <div class="admin-section">
        <h3 class="text-lg font-bold mb-4 text-cyan-400 flex items-center gap-2">
          <span>✍️</span> กรอกผลการแข่งขัน
        </h3>
        
        <div class="space-y-4 mb-4">
          <div>
            <label class="text-sm text-slate-300 mb-2 block">ทีมเหย้า</label>
            <select id="home-team-select" class="input-field">
              <option value="">เลือกทีมเหย้า</option>
            </select>
          </div>
          
          <div>
            <label class="text-sm text-slate-300 mb-2 block text-center">ผลการแข่งขัน</label>
            <div class="flex gap-3 items-center justify-center">
              <input type="number" id="home-score" class="input-field text-center text-3xl font-bold w-24" placeholder="0" min="0">
              <span class="text-3xl font-bold text-cyan-400">:</span>
              <input type="number" id="away-score" class="input-field text-center text-3xl font-bold w-24" placeholder="0" min="0">
            </div>
          </div>
          
          <div>
            <label class="text-sm text-slate-300 mb-2 block">ทีมเยือน</label>
            <select id="away-team-select" class="input-field">
              <option value="">เลือกทีมเยือน</option>
            </select>
          </div>
        </div>
        
        <button id="submit-result-btn" class="button button-success w-full flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          บันทึกผลการแข่งขัน
        </button>
      </div>

      <div class="admin-section border-2 border-rose-500/30">
        <h3 class="text-lg font-bold mb-4 text-rose-400 flex items-center gap-2">
          <span>🔄</span> รีเซ็ตข้อมูล
        </h3>
        <p class="text-sm text-slate-400 mb-4">ลบข้อมูลทั้งหมดและเริ่มต้นใหม่</p>
        <button id="reset-season-btn" class="button button-danger w-full flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          รีเซ็ตฤดูกาล
        </button>
      </div>

      <div id="recent-matches" class="mt-6">
        <h3 class="text-lg font-bold mb-4 text-cyan-400 flex items-center gap-2">
          <span>📋</span> ผลการแข่งขันล่าสุด
        </h3>
        <div id="recent-matches-list" class="space-y-2">
                  </div>
      </div>
    </div>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcxVAP08XMiPMoqElaKM7AYY_2z08oWok",
      authDomain: "xobybestry777.firebaseapp.com",
      projectId: "xobybestry777",
      storageBucket: "xobybestry777.firebasestorage.app",
      messagingSenderId: "380539937989",
      appId: "1:380539937989:web:48049ed77f45327e033cac",
      measurementId: "G-YZWTKXL285"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const TEAMS = [
      { id: 'oakley', name: 'โอแคทลิเวอร์', color: '#3b82f6', shortName: 'OAK' },
      { id: 'petchkasem', name: 'เพชรเกษมซอย5', color: '#ef4444', shortName: 'PTK' },
      { id: 'tulytween', name: 'ทิวลี่ทวีน', color: '#10b981', shortName: 'TLT' },
      { id: 'plummy', name: 'ปลามมี่ทีเด็ด', color: '#f59e0b', shortName: 'PLM' },
      { id: 'bestdevil', name: 'เบสปีศาจ', color: '#8b5cf6', shortName: 'BSD' }
    ];

    const LEAGUE_DOC = 'football_league_2025';
    
    let AppState = {
      leagueData: null,
      unsubscribe: null
    };

    const DOM = {
      screens: {
        mainMenu: document.getElementById('main-menu'),
        table: document.getElementById('table-screen'),
        fixtures: document.getElementById('fixtures-screen'),
        admin: document.getElementById('admin-screen')
      },
      loadingOverlay: document.getElementById('loading-overlay')
    };

    function showLoading() {
      DOM.loadingOverlay.classList.add('active');
    }

    function hideLoading() {
      DOM.loadingOverlay.classList.remove('active');
    }

    function showScreen(screenName) {
      Object.values(DOM.screens).forEach(s => s.classList.remove('active'));
      DOM.screens[screenName].classList.add('active');
      window.scrollTo(0, 0);
    }
    
    function generateInitialData() {
      const initialData = {
        teams: {},
        matches: [],
        createdAt: serverTimestamp()
      };
      
      TEAMS.forEach(team => {
        initialData.teams[team.id] = {
          name: team.name,
          played: 0,
          won: 0,
          drawn: 0,
          lost: 0,
          goalsFor: 0,
          goalsAgainst: 0,
          points: 0
        };
      });
      return initialData;
    }

    async function initializeLeague() {
      const leagueRef = doc(db, "leagues", LEAGUE_DOC);
      const leagueSnap = await getDoc(leagueRef);
      
      if (!leagueSnap.exists()) {
        const initialData = generateInitialData();
        await setDoc(leagueRef, initialData);
        return initialData;
      }
      
      return leagueSnap.data();
    }

    function listenToLeagueUpdates() {
      const leagueRef = doc(db, "leagues", LEAGUE_DOC);
      
      AppState.unsubscribe = onSnapshot(leagueRef, (docSnap) => {
        if (docSnap.exists()) {
          AppState.leagueData = docSnap.data();
          updateAllViews();
        }
      });
    }

    function updateAllViews() {
      if (!AppState.leagueData) return;
      renderLeagueTable();
      renderFixtures();
      renderRecentMatches();
    }

    function renderLeagueTable() {
      const tbody = document.getElementById('league-table-body');
      if (!AppState.leagueData) return;
      
      const sortedTeams = Object.entries(AppState.leagueData.teams)
        .map(([id, data]) => ({
          id,
          ...data,
          team: TEAMS.find(t => t.id === id),
          goalDiff: data.goalsFor - data.goalsAgainst
        }))
        .sort((a, b) => {
          if (b.points !== a.points) return b.points - a.points;
          if (b.goalDiff !== a.goalDiff) return b.goalDiff - a.goalDiff;
          return b.goalsFor - a.goalsFor;
        });
      
      tbody.innerHTML = sortedTeams.map((team, index) => {
        const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
        return `
          <div class="table-row ${rankClass} grid grid-cols-12 gap-2 items-center px-4 py-3">
            <div class="col-span-1 font-bold text-white text-lg">${index + 1}</div>
            <div class="col-span-5 flex items-center gap-3">
              <div class="team-badge" style="background-color: ${team.team.color};">
                ${team.team.shortName}
              </div>
              <span class="font-semibold text-white truncate">${team.name}</span>
            </div>
            <div class="col-span-1 text-center font-medium text-slate-300">${team.played}</div>
            <div class="col-span-1 text-center font-medium text-green-400">${team.won}</div>
            <div class="col-span-1 text-center font-medium text-yellow-400">${team.drawn}</div>
            <div class="col-span-1 text-center font-medium text-rose-400">${team.lost}</div>
            <div class="col-span-2 text-center font-bold text-lg text-cyan-400">${team.points}</div>
          </div>
        `;
      }).join('');
    }
    
    function renderFixtures() {
      const container = document.getElementById('fixtures-container');
      if (!AppState.leagueData || AppState.leagueData.matches.length === 0) {
        container.innerHTML = `<div class="glass-card p-6 text-center text-slate-400">ยังไม่มีการแข่งขันที่บันทึกไว้</div>`;
        return;
      }
      const allMatches = [...AppState.leagueData.matches].reverse();
      container.innerHTML = allMatches.map(match => {
        const home = TEAMS.find(t => t.id === match.homeId);
        const away = TEAMS.find(t => t.id === match.awayId);
        return `
          <div class="match-card completed">
            <div class="flex items-center justify-between">
              <div class="flex-1 text-left flex items-center gap-3">
                <div class="team-badge" style="background-color: ${home.color};">${home.shortName}</div>
                <span class="font-bold text-lg">${home.name}</span>
              </div>
              <div class="score-display px-4">${match.homeScore}</div>
            </div>
            <div class="flex items-center justify-between mt-3">
              <div class="flex-1 text-left flex items-center gap-3">
                <div class="team-badge" style="background-color: ${away.color};">${away.shortName}</div>
                <span class="font-bold text-lg">${away.name}</span>
              </div>
              <div class="score-display px-4">${match.awayScore}</div>
            </div>
            <div class="text-center mt-4">
              <span class="stats-badge bg-cyan-500/20 text-cyan-300">แข่งขันแล้ว</span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderRecentMatches() {
      const list = document.getElementById('recent-matches-list');
      if (!AppState.leagueData || AppState.leagueData.matches.length === 0) {
        list.innerHTML = `<p class="text-slate-400 text-center py-4">ยังไม่มีผลการแข่งขัน</p>`;
        return;
      }
      // Show most recent 5 first
      const recent = [...AppState.leagueData.matches].reverse().slice(0, 5);
      list.innerHTML = recent.map(match => {
        const home = TEAMS.find(t => t.id === match.homeId);
        const away = TEAMS.find(t => t.id === match.awayId);
        return `
          <div class="match-card completed p-4">
            <div class="flex justify-between items-center">
              <span class="font-semibold text-white">${home.name}</span>
              <span class="font-bold text-lg text-green-400">${match.homeScore}</span>
            </div>
            <div class="flex justify-between items-center mt-1">
              <span class="font-semibold text-white">${away.name}</span>
              <span class="font-bold text-lg text-green-400">${match.awayScore}</span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function populateAdminSelects() {
      const homeSelect = document.getElementById('home-team-select');
      const awaySelect = document.getElementById('away-team-select');
      const options = TEAMS.map(team => `<option value="${team.id}">${team.name}</option>`).join('');
      homeSelect.innerHTML = `<option value="">เลือกทีมเหย้า</option>${options}`;
      awaySelect.innerHTML = `<option value="">เลือกทีมเยือน</option>${options}`;
    }
    
    async function handleSubmitResult() {
      showLoading();
      const homeId = document.getElementById('home-team-select').value;
      const awayId = document.getElementById('away-team-select').value;
      const homeScore = parseInt(document.getElementById('home-score').value);
      const awayScore = parseInt(document.getElementById('away-score').value);

      if (!homeId || !awayId || isNaN(homeScore) || isNaN(awayScore) || homeScore < 0 || awayScore < 0) {
        alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง');
        hideLoading();
        return;
      }

      if (homeId === awayId) {
        alert('ทีมเหย้าและทีมเยือนต้องเป็นคนละทีม');
        hideLoading();
        return;
      }

      // Create a deep copy to avoid mutating state before update
      const updatedData = JSON.parse(JSON.stringify(AppState.leagueData));
      
      const homeTeam = updatedData.teams[homeId];
      const awayTeam = updatedData.teams[awayId];

      // Update stats
      homeTeam.played++;
      awayTeam.played++;
      homeTeam.goalsFor += homeScore;
      homeTeam.goalsAgainst += awayScore;
      awayTeam.goalsFor += awayScore;
      awayTeam.goalsAgainst += homeScore;

      let homePoints = 0;
      let awayPoints = 0;

      if (homeScore > awayScore) { // Home wins
        homeTeam.won++;
        awayTeam.lost++;
        homePoints = 3;
      } else if (homeScore < awayScore) { // Away wins
        awayTeam.won++;
        homeTeam.lost++;
        awayPoints = 3;
      } else { // Draw
        homeTeam.drawn++;
        awayTeam.drawn++;
        homePoints = 1;
        awayPoints = 1;
      }
      
      homeTeam.points += homePoints;
      awayTeam.points += awayPoints;

      const newMatch = {
        homeId,
        awayId,
        homeScore,
        awayScore,
        timestamp: new Date().toISOString()
      };
      
      updatedData.matches.push(newMatch);

      try {
        const leagueRef = doc(db, "leagues", LEAGUE_DOC);
        await updateDoc(leagueRef, {
          teams: updatedData.teams,
          matches: updatedData.matches
        });
        
        // Clear inputs
        document.getElementById('home-team-select').value = '';
        document.getElementById('away-team-select').value = '';
        document.getElementById('home-score').value = '';
        document.getElementById('away-score').value = '';
        
        alert('บันทึกผลการแข่งขันสำเร็จ!');
      } catch (error) {
        console.error("Error submitting result: ", error);
        alert('เกิดข้อผิดพลาดในการบันทึกผล');
      } finally {
        hideLoading();
      }
    }
    
    async function handleResetSeason() {
      if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการรีเซ็ตฤดูกาล? ข้อมูลทั้งหมดจะถูกลบและไม่สามารถกู้คืนได้')) {
        return;
      }
      
      showLoading();
      try {
        const initialDataPayload = generateInitialData();
        const leagueRef = doc(db, "leagues", LEAGUE_DOC);
        await setDoc(leagueRef, initialDataPayload); // ใช้ setDoc เพื่อเขียนทับทั้งหมด
        
        alert('รีเซ็ตฤดูกาลสำเร็จ!');
        showScreen('mainMenu');
      } catch (error) {
        console.error("Error resetting season: ", error);
        alert('เกิดข้อผิดพลาดในการรีเซ็ต');
      } finally {
        hideLoading();
      }
    }
    
    function setupNavigation() {
      document.getElementById('view-table-btn').onclick = () => showScreen('table');
      document.getElementById('view-fixtures-btn').onclick = () => showScreen('fixtures');
      document.getElementById('admin-panel-btn').onclick = () => showScreen('admin');
      
      document.getElementById('back-from-table').onclick = () => showScreen('mainMenu');
      document.getElementById('back-from-fixtures').onclick = () => showScreen('mainMenu');
      document.getElementById('back-from-admin').onclick = () => showScreen('mainMenu');
    }
    
    // Main App Initialization
    async function main() {
      showLoading();
      try {
        await signInAnonymously(auth);
        await initializeLeague();
        listenToLeagueUpdates(); // จะเริ่มดึงข้อมูลและ render ครั้งแรก
        populateAdminSelects();
        setupNavigation();
        
        // Setup admin buttons
        document.getElementById('submit-result-btn').onclick = handleSubmitResult;
        document.getElementById('reset-season-btn').onclick = handleResetSeason;
        
        showScreen('mainMenu');
      } catch (error) {
        console.error("Initialization error: ", error);
        alert('ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
      } finally {
        // หน่วงเวลาเล็กน้อยเพื่อให้ดูเหมือนโหลดเสร็จ
        setTimeout(hideLoading, 500);
      }
    }
    
    main(); // เริ่มการทำงานของแอป

  </script>
</body>
</html>
