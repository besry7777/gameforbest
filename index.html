<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PARTY ‡∏Ç‡∏µ‡πâ‡πÄ‡∏´‡∏•‡πâ‡∏≤ (ONLY GAMES)</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;800&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
/* ================= CSS (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ================= */
:root {
    --bg-color: #121212;
    --card-bg: #1e1e1e;
    --primary: #00e676;
    --text-main: #ffffff;
    --text-muted: #b0b0b0;
    --danger: #ef5350;
    --warning: #ffca28;
    --radius: 16px;
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    font-family: 'Sarabun', sans-serif;
    touch-action: manipulation; 
}

body {
    background-color: var(--bg-color);
    color: var(--text-main);
    margin: 0;
    padding: 0;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#game-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    padding: 16px;
    position: relative;
    z-index: 1;
}

header {
    flex: 0 0 auto;
    text-align: center;
    margin-bottom: 10px;
}

h1 {
    font-size: 1.8rem;
    margin: 0;
    font-weight: 800;
    letter-spacing: 1px;
    color: var(--primary);
    text-transform: uppercase;
}

.display-area {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-color: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    border: 1px solid #333;
    position: relative;
    margin-bottom: 16px;
    overflow: hidden;
    min-height: 0;
}

.big-instruction {
    font-size: clamp(1.4rem, 5vw, 2.2rem);
    font-weight: 800;
    color: #fff;
    text-align: center;
    line-height: 1.4;
    width: 100%;
    word-wrap: break-word;
    z-index: 2;
    max-height: 60vh;
    overflow-y: auto;
}

.category-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 15px;
    color: #000;
    opacity: 0;
    transition: opacity 0.3s;
}

.hint-text {
    margin-top: auto;
    padding-top: 15px;
    color: var(--text-muted);
    font-size: 0.8rem;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popIn {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
.blur-anim { filter: blur(4px); opacity: 0.6; }

.controls-area {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.btn {
    width: 100%;
    padding: 18px;
    font-size: 1.3rem;
    border: none;
    border-radius: var(--radius);
    font-weight: 800;
    cursor: pointer;
    background-color: var(--primary);
    color: #000;
    transition: transform 0.1s;
}
.btn:active { transform: scale(0.97); }
.btn:disabled { background-color: #333; color: #555; cursor: not-allowed; }
.btn-secondary { background-color: #2c2c2c; color: #fff; font-size: 1rem; padding: 12px; }

#count-display {
    position: absolute; top: 10px; right: 10px;
    font-size: 0.75rem; color: #666; background: #111;
    padding: 4px 8px; border-radius: 6px;
}
#sound-toggle {
    position: absolute; top: 10px; left: 10px;
    background: transparent; color: #666; border: 1px solid #333;
    border-radius: 20px; padding: 4px 10px; font-size: 0.7rem; cursor: pointer;
}

/* Mini Games Area */
#special-game-area {
    margin-top: 15px;
    width: 100%;
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border: 1px solid #444;
}

.game-btn {
    background: var(--danger);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    margin-bottom: 10px;
}

.skip-btn {
    background: transparent;
    border: 1px solid #666;
    color: #888;
    padding: 8px 16px;
    border-radius: 30px;
    font-size: 0.9rem;
    cursor: pointer;
    margin-top: 5px;
}

.timer-text {
    font-size: clamp(3rem, 10vw, 5rem);
    font-weight: 800;
    color: var(--danger);
    font-variant-numeric: tabular-nums;
    margin: 10px 0;
}

/* Wire Buttons for Bomb Game */
.wire-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    width: 100%;
}
.wire-btn {
    height: 60px;
    border-radius: 8px;
    border: 3px solid rgba(255,255,255,0.2);
    cursor: pointer;
    transition: all 0.2s;
}

/* Modal History */
.modal-overlay {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(3px);
    z-index: 100;
    display: flex; justify-content: center; align-items: flex-end;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.modal-overlay.active { opacity: 1; pointer-events: all; }
.modal-content {
    background: #252525;
    width: 100%; max-width: 500px; height: 70vh;
    border-radius: 20px 20px 0 0;
    display: flex; flex-direction: column;
    transform: translateY(100%); transition: transform 0.3s ease;
}
.modal-overlay.active .modal-content { transform: translateY(0); }
.modal-header {
    padding: 15px 20px; border-bottom: 1px solid #333;
    display: flex; justify-content: space-between; align-items: center;
}
.modal-header h2 { margin: 0; font-size: 1.2rem; color: #fff; }
.close-modal { background: none; border: none; color: #aaa; font-size: 1.5rem; }
.history-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
.history-item {
    padding: 15px 20px; border-bottom: 1px solid #333;
    font-size: 0.9rem; display: flex; align-items: flex-start; color: #ddd;
}
.history-tag {
    font-size: 0.65rem; padding: 2px 6px; border-radius: 4px;
    margin-right: 8px; color: #000; font-weight: bold; white-space: nowrap; margin-top: 3px;
}
</style>
</head>

<body>

<div id="game-container">
    <header>
        <h1>PARTY GAME (VIP)</h1>
    </header>

    <div class="display-area">
        <button id="sound-toggle">üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        <div id="count-display"></div>

        <div id="category-badge" class="category-badge">CATEGORY</div>
        
        <div class="big-instruction" id="wheel-result">
            ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°‡∏•‡πâ‡∏ß‡∏ô<br>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏•‡∏¢!
        </div>

        <div id="special-game-area"></div>

        <div class="hint-text">ONLY MINI-GAMES EDITION</div>
    </div>

    <div class="controls-area">
        <button class="btn" id="spin-btn" onclick="startSpin()">üéÆ ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)</button>
        <button class="btn btn-secondary" onclick="openHistory()">üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
    </div>
</div>

<div class="modal-overlay" id="historyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
            <button class="close-modal" onclick="closeHistory()">‚úï</button>
        </div>
        <ul class="history-list" id="historyListDisplay"></ul>
    </div>
</div>

<audio id="clickSound" src="click.mp3"></audio>
<audio id="resultSound" src="result.mp3"></audio>
<audio id="alarmSound" src="alarm.mp3"></audio>
<audio id="gunSound" src="gun.mp3"></audio>
<audio id="bangSound" src="bang.wav"></audio>

<script>
// =================== 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏° (‡∏ï‡∏±‡∏î Normal Questions ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Logic) ===================

// ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
const allSpecialGames = [
    { t: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 40 ‡∏ß‡∏¥ ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡∏•‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô ‚Üí ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", c: "MINI GAME", color: "#ffca28", type: "timer", time: 40 },
    { t: "‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà 5.00 ‡∏ß‡∏¥ (¬±0.10) ‡πÉ‡∏Ñ‡∏£‡∏û‡∏•‡∏≤‡∏î‡∏î‡∏∑‡πà‡∏°!", c: "SKILL", color: "#42a5f5", type: "stopwatch", target: 5.00, range: 0.10 },
    { t: "‡∏™‡πà‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ß‡∏ô‡πÑ‡∏õ ‡∏Å‡∏î‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡πÑ‡∏Å..‡πÉ‡∏Ñ‡∏£‡πÇ‡∏î‡∏ô‡∏î‡∏∑‡πà‡∏°!", c: "LUCK", color: "#ef5350", type: "roulette" },
    { t: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏î‡∏™‡∏≤‡∏¢‡πÑ‡∏ü 1 ‡πÄ‡∏™‡πâ‡∏ô...‡πÉ‡∏Ñ‡∏£‡∏ó‡∏≥‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏î‡∏∑‡πà‡∏°!", c: "BOMB", color: "#ef5350", type: "bomb" },
    { t: "‡πÄ‡∏Å‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥! ‡∏à‡∏≥‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏î‡∏µ ‡∏ó‡∏≤‡∏¢‡∏ú‡∏¥‡∏î‡∏î‡∏∑‡πà‡∏°!", c: "MEMORY", color: "#ab47bc", type: "memory" },
    { t: "‡∏™‡∏∏‡πà‡∏° A ‡∏ñ‡∏∂‡∏á Z ‡πÉ‡∏Ñ‡∏£‡∏°‡∏µ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡∏î‡∏∑‡πà‡∏°!", c: "NAME", color: "#00ccff", type: "alphabet" },
    { t: "‡∏à‡∏≥‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô! (Simon Says)", c: "MEMORY", color: "#e91e63", type: "simon" },
    { t: "‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡∏ß‡∏î‡∏ß‡∏±‡∏î‡∏î‡∏ß‡∏á! (‡∏ä‡∏µ‡πâ‡πÉ‡∏Ñ‡∏£‡∏î‡∏∑‡πà‡∏°)", c: "LUCK", color: "#8bc34a", type: "bottle" },
    { t: "‡∏ö‡∏ß‡∏Å‡∏•‡∏ö‡πÄ‡∏•‡∏Ç‡πÑ‡∏´‡∏•! (‡πÄ‡∏ä‡πà‡∏ô 2+3-1=?)", c: "MATH", color: "#607d8b", type: "chainmath" },
    { t: "‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°‡∏à‡∏¥‡πâ‡∏°‡∏à‡∏≠! (2 ‡∏Ñ‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏à‡∏¥‡πâ‡∏°)", c: "BATTLE", color: "#ff1744", type: "tapwar" },
];

// =================== 2. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö ===================
let gamePool = [...allSpecialGames]; // ‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏∏‡πà‡∏° (‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ)
let history = []; 
let soundEnabled = true;

const clickSound = document.getElementById("clickSound");
const resultSound = document.getElementById("resultSound");
const alarmSound = document.getElementById("alarmSound");
const gunSound = document.getElementById("gunSound");
const bangSound = document.getElementById("bangSound");
const soundToggle = document.getElementById("sound-toggle");

const resultDisplay = document.getElementById('wheel-result');
const spinBtn = document.getElementById('spin-btn');
const countDisplay = document.getElementById('count-display');
const categoryBadge = document.getElementById('category-badge');
const specialGameArea = document.getElementById('special-game-area');

// =================== 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ===================

soundToggle.onclick = () => {
    soundEnabled = !soundEnabled;
    soundToggle.innerText = soundEnabled ? "üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á" : "üîá ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
    soundToggle.style.opacity = soundEnabled ? "1" : "0.5";
};

function playSound(sound) {
    if (!soundEnabled) return;
    if (!sound.paused) {
        sound.pause();
        sound.currentTime = 0;
    }
    sound.play().catch(()=>{});
}

function updateCountDisplay() {
    // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏Å‡∏≠‡∏á
    countDisplay.innerText = `Games Left: ${gamePool.length} / ${allSpecialGames.length}`;
}

updateCountDisplay();

function startSpin() {
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    specialGameArea.style.display = 'none';
    specialGameArea.innerHTML = ''; 
    categoryBadge.style.opacity = '0';
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏°‡∏´‡∏°‡∏î‡∏Å‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (gamePool.length === 0) {
        alert("üéâ ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà");
        gamePool = [...allSpecialGames]; // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏≠‡∏á
        updateCountDisplay();
    }

    playSound(clickSound); 
    spinBtn.disabled = true;
    resultDisplay.classList.remove("pop-in");
    resultDisplay.classList.add("blur-anim");

    // Animation ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏°‡∏≤‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏ä‡∏ß‡πå)
    let shuffleInterval = setInterval(() => {
        const randomPreview = allSpecialGames[Math.floor(Math.random() * allSpecialGames.length)];
        resultDisplay.innerText = randomPreview.t; 
        resultDisplay.style.fontSize = "1.2rem"; // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏¢‡∏≤‡∏Å
    }, 50);

    setTimeout(() => {
        clearInterval(shuffleInterval);
        resultDisplay.style.fontSize = ""; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå
        processResult();
    }, 1200);
}

function processResult() {
    // ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏≤‡∏Å gamePool
    const index = Math.floor(Math.random() * gamePool.length);
    const selectedObj = gamePool[index];

    // ‡∏•‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≠‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥)
    gamePool.splice(index, 1);

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    history.unshift(selectedObj);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    resultDisplay.classList.remove("blur-anim");
    resultDisplay.innerText = selectedObj.t;
    categoryBadge.innerText = selectedObj.c;
    categoryBadge.style.backgroundColor = selectedObj.color;
    categoryBadge.style.color = "#000"; 
    categoryBadge.style.opacity = '1';

    void resultDisplay.offsetWidth; // Trigger reflow
    resultDisplay.classList.add("pop-in");
    playSound(resultSound);

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    setupGame(selectedObj);
    
    updateCountDisplay();
}

// =================== 4. Logic Games (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===================

async function setupGame(gameObj) {
    specialGameArea.style.display = 'flex';
    if (gameObj.type === 'timer') setupTimerGame(gameObj.time);
    else if (gameObj.type === 'stopwatch') setupStopwatchGame(gameObj.target, gameObj.range);
    else if (gameObj.type === 'roulette') setupRouletteGame();
    else if (gameObj.type === 'bomb') setupBombGame();
    else if (gameObj.type === 'memory') setupMemoryGame();
    else if (gameObj.type === 'alphabet') setupAlphabetGame(); 
    else if (gameObj.type === 'simon') setupSimonGame();
    else if (gameObj.type === 'bottle') setupBottleGame();
    else if (gameObj.type === 'chainmath') setupChainMathGame();
    else if (gameObj.type === 'tapwar') setupTapWarGame();
}

function skipGame() {
    if(window.currentInterval) clearInterval(window.currentInterval);
    if(window.mathTimer) clearInterval(window.mathTimer);
    specialGameArea.style.display = 'none';
    spinBtn.disabled = false;
    playSound(clickSound);
}

function getSkipButtonHTML() {
    return `<button class="skip-btn" onclick="skipGame()">‚è≠ ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ / ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>`;
}

// --- Game Logic Functions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞) ---

function setupTimerGame(seconds) {
    specialGameArea.innerHTML = `<button class="game-btn" onclick="runTimer(${seconds})">‚è±Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (${seconds} ‡∏ß‡∏¥)</button>${getSkipButtonHTML()}`;
}
function runTimer(seconds) {
    let timeLeft = seconds;
    specialGameArea.innerHTML = `<div class="timer-text" id="game-timer">${timeLeft}</div>${getSkipButtonHTML()}`;
    window.currentInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('game-timer').innerText = timeLeft;
        if (timeLeft <= 5 && timeLeft > 0) playSound(clickSound);
        if (timeLeft <= 0) {
            clearInterval(window.currentInterval);
            document.getElementById('game-timer').innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!";
            playSound(alarmSound);
            spinBtn.disabled = false;
        }
    }, 1000);
}

function setupStopwatchGame(target, range) {
    specialGameArea.style.display = 'flex';
    specialGameArea.innerHTML = `
        <div style="margin-bottom:10px; font-size:1.1rem;">
            ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <span style="color:#00e676; font-weight:800;">
            ${target.toFixed(2)}</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        </div>
        <div style="font-size:0.8rem; color:#aaa; margin-bottom:15px;">
            (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2.00 ‡∏ß‡∏¥ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ!)
        </div>
        <button class="game-btn" onclick="runStopwatch(${target}, ${range})">
            ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤!
        </button>
        ${getSkipButtonHTML()}
    `;
}

function runStopwatch(target, range) {
    if (window.currentInterval) clearInterval(window.currentInterval);
    window.swStart = performance.now();

    specialGameArea.innerHTML = `
        <div class="timer-text" id="sw-display">0.00</div>
        <div id="blind-status" style="margin-bottom:15px; height:20px; color:#ffca28; font-weight:bold;"></div>
        <button class="game-btn" id="stop-btn">üü• ‡∏´‡∏¢‡∏∏‡∏î!</button>
        ${getSkipButtonHTML()}
    `;

    const stopBtn = document.getElementById("stop-btn");
    stopBtn.addEventListener("click", () => { stopStopwatch(target, range); });

    window.currentInterval = setInterval(() => {
        const elapsed = (performance.now() - window.swStart) / 1000;
        const display = document.getElementById("sw-display");
        const status = document.getElementById("blind-status");

        if (!display) return;
        if (elapsed <= 2) {
            display.innerText = elapsed.toFixed(2);
        } else {
            display.innerText = "?.??";
            display.style.color = "#ef5350";
            status.innerText = "üôà ‡πÉ‡∏ä‡πâ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏ç‡∏≤‡∏ì‡∏•‡πâ‡∏ß‡∏ô ‡πÜ";
        }
    }, 30);
}

function stopStopwatch(target, range) {
    if (!window.swStart) return;
    clearInterval(window.currentInterval);
    window.currentInterval = null;

    const finalTime = (performance.now() - window.swStart) / 1000;
    window.swStart = null;
    const diff = Math.abs(finalTime - target);
    const display = document.getElementById("sw-display");
    const status = document.getElementById("blind-status");
    const stopBtn = document.getElementById("stop-btn");

    if (!display || !stopBtn) return;
    display.innerText = finalTime.toFixed(2);
    display.style.color = "#fff";

    if (diff <= range) {
        playSound(alarmSound);
        status.innerText = `üéØ ‡πÅ‡∏°‡πà‡∏ô! ‡∏û‡∏•‡∏≤‡∏î ${diff.toFixed(2)} ‡∏ß‡∏¥`;
        status.style.color = "#00e676";
        stopBtn.innerText = "‡∏£‡∏≠‡∏î! ‚úÖ";
        stopBtn.style.background = "#00e676";
    } else {
        playSound(bangSound);
        status.innerText = `üíÄ ‡∏û‡∏•‡∏≤‡∏î ${diff.toFixed(2)} ‡∏ß‡∏¥`;
        status.style.color = "#ef5350";
        stopBtn.innerText = "‡∏î‡∏∑‡πà‡∏°! üç∫";
        stopBtn.style.background = "#ef5350";
    }
    stopBtn.disabled = true;
    spinBtn.disabled = false;
}

function setupRouletteGame() {
    window.bulletChamber = Math.floor(Math.random() * 6);
    window.currentChamber = 0;
    specialGameArea.style.display = 'flex';
    specialGameArea.style.animation = "none"; 
    
    specialGameArea.innerHTML = `
        <div id="cylinder-container" style="display: flex; gap: 5px; margin-bottom: 20px;">
            ${Array(6).fill().map((_, i) => `<div id="chamber-${i}" style="width: 30px; height: 30px; border-radius: 50%; border: 2px solid #555; background: #222;"></div>`).join('')}
        </div>
        <div id="roulette-status" style="margin-bottom:15px; font-weight: bold; color: var(--warning);">‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏¥‡∏á... ‡πÉ‡∏Ñ‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ?</div>
        <button class="game-btn" id="trigger-btn" onclick="pullTrigger()">ü§û ‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡πÑ‡∏Å (‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà 1)</button>
        ${getSkipButtonHTML()}
    `;
}

function pullTrigger() {
    const btn = document.getElementById('trigger-btn');
    const currentDot = document.getElementById(`chamber-${window.currentChamber}`);
    
    btn.disabled = true;
    currentDot.style.background = "#fff"; 
    playSound(gunSound); 

    setTimeout(() => {
        if (window.currentChamber === window.bulletChamber) {
            playSound(bangSound);
            currentDot.style.background = "#ef5350";
            currentDot.style.boxShadow = "0 0 15px #ef5350";
            
            specialGameArea.innerHTML = `
                <div class="timer-text" style="font-size: 5rem;">üíÄ</div>
                <div style="color:#ef5350; font-size: 1.5rem; font-weight:bold; margin-bottom: 10px;">‡∏õ‡∏±‡∏á! ‡∏ï‡∏≤‡∏¢‡∏™‡∏ô‡∏¥‡∏ó</div>
                <div style="margin-bottom: 15px; color: #ddd;">‡∏à‡∏±‡∏î‡πÑ‡∏õ‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏Å‡πâ‡∏ß‡πÄ‡∏ï‡πá‡∏°‡πÜ!</div>
                ${getSkipButtonHTML()}
            `;
            spinBtn.disabled = false;
        } else {
            playSound(clickSound); 
            currentDot.style.background = "#444"; 
            currentDot.innerHTML = "‚úï";
            currentDot.style.display = "flex";
            currentDot.style.alignItems = "center";
            currentDot.style.justifyContent = "center";
            currentDot.style.fontSize = "12px";
            currentDot.style.color = "#888";
            
            window.currentChamber++;
            btn.disabled = false;
            btn.innerText = `ü§û ‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡πÑ‡∏Å (‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà ${window.currentChamber + 1})`;
            const statusLabel = document.getElementById('roulette-status');
            statusLabel.innerText = `‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà ${window.currentChamber} ‡∏£‡∏≠‡∏î! ‡∏™‡πà‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠...`;
            statusLabel.style.color = "#00e676";
        }
    }, 800);
}

function setupBombGame() {
    const bombWire = Math.floor(Math.random() * 4);
    const colors = ["#ef5350", "#00e676", "#42a5f5", "#ffca28"];
    let wiresHTML = colors.map((color, i) => `
        <div class="wire-btn" 
             style="background:${color}; position:relative; overflow:hidden; border:none; box-shadow: 0 4px #000, inset 0 -4px rgba(0,0,0,0.2);" 
             onclick="cutWire(this, ${i === bombWire})">
             <div style="position:absolute; top:50%; width:100%; height:2px; background:rgba(255,255,255,0.3);"></div>
        </div>
    `).join('');

    specialGameArea.style.display = 'flex';
    specialGameArea.innerHTML = `
        <div style="margin-bottom:15px; color:var(--danger); font-weight:bold; letter-spacing:2px;" id="bomb-hint">‚ö†Ô∏è ‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô! ‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏™‡πâ‡∏ô</div>
        <div class="wire-container" style="padding: 10px; background: #333; border-radius: 10px; border: 4px solid #444;">
            ${wiresHTML}
        </div>
        ${getSkipButtonHTML()}
    `;
}

function cutWire(el, isBomb) {
    if (isBomb) {
        playSound(bangSound); 
        el.style.background = "#000";
        el.style.transform = "translateY(4px)";
        el.style.boxShadow = "none";
        
        document.body.style.background = "#ef5350";
        setTimeout(() => { document.body.style.background = "var(--bg-color)"; }, 200);

        specialGameArea.innerHTML = `
            <div class="timer-text">üí•</div>
            <div style="color:#ef5350; font-size: 2rem; font-weight:800; text-shadow: 0 0 10px rgba(0,0,0,0.5);">‡∏ö‡∏∂‡πâ‡∏°‡∏°‡∏°‡∏°‡∏°!</div>
            <div style="margin-top: 10px;">‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏ô‡πÄ‡∏´‡∏£‡∏≠? ‡∏î‡∏∑‡πà‡∏°‡∏ã‡∏∞!</div>
            ${getSkipButtonHTML()}
        `;
        specialGameArea.style.animation = "shake 0.5s infinite";
        setTimeout(() => { specialGameArea.style.animation = ""; }, 500);
        resultDisplay.innerText = "‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏î‡∏∑‡πà‡∏°‡∏°‡∏°‡∏°";
        spinBtn.disabled = false;
    } else {
        playSound(clickSound); 
        el.style.opacity = "0.2";
        el.style.transform = "translateY(2px)";
        el.style.pointerEvents = "none";
        document.getElementById('bomb-hint').innerText = "‡∏£‡∏≠‡∏î‡πÑ‡∏õ... ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°!";
        document.getElementById('bomb-hint').style.color = "#00e676";
    }
}

function setupMemoryGame() {
    const num = Math.floor(10000 + Math.random() * 90000);
    specialGameArea.innerHTML = `<div style="font-size:0.9rem; margin-bottom:10px; color:#aaa;">‡∏à‡∏î‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡πÉ‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ!</div><div class="timer-text" id="mem-num" style="color:#00e676;">${num}</div><div style="width:100%; height:6px; background:#333; border-radius:10px; overflow:hidden; margin-top:10px;"><div id="mem-progress" style="width:100%; height:100%; background:#00e676; transition: width 2s linear;"></div></div>`;
    setTimeout(() => { const progressBar = document.getElementById('mem-progress'); if(progressBar) progressBar.style.width = '0%'; }, 50);
    setTimeout(() => {
        const memNumDisplay = document.getElementById('mem-num');
        if (memNumDisplay) {
            specialGameArea.innerHTML = `<div style="font-size:1.1rem; margin-bottom:15px; font-weight:bold;">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ‡πÄ‡∏•‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£!?</div><input type="number" id="mem-input" autocomplete="off" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏î‡πâ" style="padding:15px; border-radius:12px; border:2px solid #00e676; width:90%; text-align:center; font-size:1.8rem; background:#000; color:#fff; margin-bottom:15px; outline:none;"><button class="game-btn" onclick="checkMemory(${num})" style="background:#00e676; color:#000;">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>${getSkipButtonHTML()}`;
            document.getElementById('mem-input').focus();
        }
    }, 2000);
}
function checkMemory(correct) {
    const inputEl = document.getElementById('mem-input');
    const val = parseInt(inputEl.value);
    if (val === correct) { resultDisplay.innerText = "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏£‡∏≠‡∏î‡∏ï‡∏≤‡∏¢"; playSound(resultSound); }
    else { resultDisplay.innerText = `‡∏ú‡∏¥‡∏î! ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${correct}`; playSound(bangSound); }
    specialGameArea.innerHTML = getSkipButtonHTML(); spinBtn.disabled = false;
}

function setupAlphabetGame() {
    specialGameArea.innerHTML = `
        <div id="alpha-display" class="timer-text" style="color:#00ccff;">?</div>
        <button class="game-btn" id="alpha-btn" onclick="runAlphabetSpin()">üé∞ ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£!</button>
        ${getSkipButtonHTML()}
    `;
}

function runAlphabetSpin() {
    const btn = document.getElementById('alpha-btn');
    const display = document.getElementById('alpha-display');
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    btn.disabled = true;
    
    let counter = 0;
    let speed = 50;
    let spinInterval = setInterval(() => {
        const randomChar = letters[Math.floor(Math.random() * letters.length)];
        display.innerText = randomChar;
        playSound(clickSound);
        counter++;
        
        if (counter > 20) {
            clearInterval(spinInterval);
            const finalLetter = letters[Math.floor(Math.random() * letters.length)];
            display.innerText = finalLetter;
            display.style.fontSize = "6rem"; 
            playSound(resultSound);
            btn.innerText = "‡πÉ‡∏Ñ‡∏£‡∏°‡∏µ‡∏ï‡∏±‡∏ß '" + finalLetter + "' ‡∏î‡∏∑‡πà‡∏°!";
            btn.style.background = "#444";
            spinBtn.disabled = false; 
        }
    }, speed);
}

function setupSimonGame() {
    specialGameArea.style.display = 'flex';
    specialGameArea.innerHTML = `
        <div style="margin-bottom:10px; font-size:0.9rem; color:#aaa;">‡∏à‡∏≥‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏ü 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å!</div>
        <button class="game-btn" id="start-simon-btn" onclick="startSimon()">üß† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≥‡∏î‡∏±‡∏ö!</button>
        ${getSkipButtonHTML()}
    `;
}

function startSimon() {
    const btn = document.getElementById('start-simon-btn');
    if(btn) btn.style.display = 'none';

    const colors = ['#f44336', '#4caf50', '#2196f3', '#ffeb3b', '#9c27b0', '#ff9800']; const seq = Array.from({length: 5}, () => Math.floor(Math.random() * 6)); let userIdx = 0;
    
    let html = `<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; width:100%;">`;
    colors.forEach((c, i) => {
        html += `<div id="simon-${i}" style="height:70px; background:${c}; opacity:0.2; border-radius:10px; transition:all 0.1s; border: 2px solid rgba(255,255,255,0.1);"></div>`;
    });
    html += `</div><div id="simon-status" style="margin-top:10px; color:var(--warning);">‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏î‡∏π...</div>`;
    specialGameArea.innerHTML = html;

    let i = 0;
    const interval = setInterval(() => {
        if(i >= seq.length) {
            clearInterval(interval);
            document.getElementById('simon-status').innerText = "‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏¢";
            document.getElementById('simon-status').style.color = "#00e676";
            
            colors.forEach((c, idx) => {
                const el = document.getElementById(`simon-${idx}`);
                el.style.opacity = "1";
                el.style.cursor = "pointer";
                
                el.onclick = () => {
                    el.style.transform = "scale(0.9)";
                    setTimeout(() => el.style.transform = "scale(1)", 100);

                    if(idx !== seq[userIdx]) {
                        playSound(bangSound); 
                        resultDisplay.innerText = "‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏î‡∏∑‡πà‡∏°‡∏ã‡∏∞‡∏î‡∏µ‡πÜ";
                        document.getElementById('simon-status').innerText = "‚ùå ‡∏ú‡∏¥‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö!";
                        document.getElementById('simon-status').style.color = "#ef5350";
                        spinBtn.disabled = false;
                        document.querySelectorAll('[id^="simon-"]').forEach(d => d.onclick = null);
                    } else {
                        playSound(clickSound); 
                        userIdx++;
                        if(userIdx === seq.length) {
                            playSound(resultSound); 
                            resultDisplay.innerText = "‡∏™‡∏°‡∏≠‡∏á‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏£‡∏≠‡∏î‡∏ï‡∏≤‡∏¢";
                            document.getElementById('simon-status').innerText = "‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!";
                            spinBtn.disabled = false;
                            document.querySelectorAll('[id^="simon-"]').forEach(d => d.onclick = null);
                        }
                    }
                };
            });
            return;
        }

        const active = document.getElementById(`simon-${seq[i]}`);
        if(active) {
            active.style.opacity = "1";
            active.style.boxShadow = `0 0 20px ${colors[seq[i]]}`;
            active.style.transform = "scale(1.05)";
            playSound(clickSound);
            setTimeout(() => {
                active.style.opacity = "0.2";
                active.style.boxShadow = "none";
                active.style.transform = "scale(1)";
            }, 450);
        }
        i++;
    }, 700); 
}

function setupBottleGame() {
    specialGameArea.innerHTML = `<div id="bottle" style="font-size:4rem; transition: transform 3s ease-out;">üçæ</div><button class="game-btn" style="margin-top:20px;" onclick="spinBottle()">‡∏´‡∏°‡∏∏‡∏ô!</button>${getSkipButtonHTML()}`;
}
function spinBottle() {
    const rot = 720 + Math.floor(Math.random() * 360);
    document.getElementById('bottle').style.transform = `rotate(${rot}deg)`;
    playSound(clickSound);
    setTimeout(() => {
        resultDisplay.innerText = "‡∏Ç‡∏ß‡∏î‡∏ä‡∏µ‡πâ‡πÉ‡∏Ñ‡∏£ ‡∏î‡∏∑‡πà‡∏°!";
        playSound(alarmSound);
        spinBtn.disabled = false;
    }, 3000);
}

function setupChainMathGame() {
    const ops = ['+', '-'];
    const n1 = Math.floor(Math.random() * 15) + 5; 
    const n2 = Math.floor(Math.random() * 9) + 1;
    const n3 = Math.floor(Math.random() * 9) + 1;
    const op1 = ops[Math.floor(Math.random() * 2)];
    const op2 = ops[Math.floor(Math.random() * 2)];
    const eq = `${n1}${op1}${n2}${op2}${n3}`;
    const ans = eval(eq);
    
    specialGameArea.style.display = 'flex';
    specialGameArea.innerHTML = `
        <div style="margin-bottom:10px; color:#ffca28;">‡∏Ñ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÑ‡∏ß! ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
        <div class="timer-text" style="font-size: 3rem; margin-bottom:10px;">${eq} = ?</div>
        
        <div style="width:100%; height:10px; background:#444; border-radius:5px; margin-bottom:20px; overflow:hidden;">
            <div id="math-progress" style="width:100%; height:100%; background:#ef5350; transition: width 0.1s linear;"></div>
        </div>

        <input type="number" id="math-ans" pattern="[0-9]*" inputmode="numeric" 
               style="width:60%; padding:15px; text-align:center; font-size:1.5rem; border-radius:10px; border:none; margin-bottom:15px;" 
               placeholder="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...">
        
        <button class="game-btn" id="math-submit" onclick="solveChain(${ans})">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö!</button>
        ${getSkipButtonHTML()}
    `;

    setTimeout(() => document.getElementById('math-ans').focus(), 100);

    let timeLeft = 7.0;
    const totalTime = 7.0;
    
    window.mathTimer = setInterval(() => {
        timeLeft -= 0.1;
        const progressBar = document.getElementById('math-progress');
        if(progressBar) {
            const percent = (timeLeft / totalTime) * 100;
            progressBar.style.width = percent + "%";
        }
        if (timeLeft <= 0) {
            clearInterval(window.mathTimer);
            failMathGame(ans); 
        }
    }, 100);
}

function solveChain(ans) {
    clearInterval(window.mathTimer);
    const input = document.getElementById('math-ans');
    const user = parseInt(input.value);
    
    if (user === ans) {
        resultDisplay.innerText = "‡∏™‡∏°‡∏≠‡∏á‡πÑ‡∏ß! ‡∏£‡∏≠‡∏î‡∏ï‡∏≤‡∏¢";
        resultDisplay.style.color = "#00e676";
        playSound(resultSound);
        specialGameArea.innerHTML = `<div class="timer-text" style="color:#00e676;">‚úÖ ${ans}</div><div style="margin-top:10px;">‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏£‡∏≠‡∏î‡πÑ‡∏õ...</div>`;
    } else {
        failMathGame(ans);
    }
    spinBtn.disabled = false;
}

function failMathGame(correctAns) {
    clearInterval(window.mathTimer);
    playSound(bangSound); 
    specialGameArea.style.animation = "shake 0.5s";
    specialGameArea.innerHTML = `
        <div class="timer-text" style="color:#ef5350;">üí• ‡∏ö‡∏∂‡πâ‡∏°!</div>
        <div style="color:#ef5350; font-weight:bold; font-size:1.2rem;">‡πÄ‡∏â‡∏•‡∏¢‡∏Ñ‡∏∑‡∏≠: ${correctAns}</div>
        <div style="margin-top:10px;">‡∏Ñ‡∏¥‡∏î‡∏ä‡πâ‡∏≤/‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î ‡∏à‡∏±‡∏î‡πÑ‡∏õ 1 ‡πÅ‡∏Å‡πâ‡∏ß!</div>
    `;
    resultDisplay.innerText = "‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏î‡∏∑‡πà‡∏°‡∏°‡∏°‡∏°";
    spinBtn.disabled = false;
}

function setupTapWarGame() {
    window.warScore = 50; 
    window.warActive = false;
    
    specialGameArea.style.display = 'flex';
    specialGameArea.innerHTML = `
        <div id="tap-war-container" style="width:100%; position:relative;">
            <div style="text-align:center; color:#fff; margin-bottom:10px; font-weight:bold;">
                üîµ ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô VS ‡πÅ‡∏î‡∏á üî¥
            </div>
            
            <div id="battle-field" style="display:flex; height:200px; width:100%; border-radius:15px; overflow:hidden; border:3px solid #444; position:relative;">
                <div id="p1-area" onclick="tapWar(1)" style="flex:50; background:linear-gradient(45deg, #1976d2, #2196f3); transition: flex 0.1s ease-out; cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <span style="font-size:2rem;">üîµ</span>
                    <span id="p1-percent" style="font-weight:bold;">50%</span>
                </div>
                <div id="p2-area" onclick="tapWar(2)" style="flex:50; background:linear-gradient(45deg, #f44336, #d32f2f); transition: flex 0.1s ease-out; cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <span style="font-size:2rem;">üî¥</span>
                    <span id="p2-percent" style="font-weight:bold;">50%</span>
                </div>
                
                <div id="war-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:10;">
                    <button class="game-btn" id="start-war-btn" onclick="startTapWarCountdown()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏®‡∏∂‡∏Å‡∏ô‡∏µ‡πâ!</button>
                </div>
            </div>
            <div id="war-hint" style="text-align:center; font-size:0.8rem; margin-top:10px; color:#aaa;">‡∏ß‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏•‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ß‡∏ô‡∏¥‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á!</div>
        </div>
    `;
}

function startTapWarCountdown() {
    const btn = document.getElementById('start-war-btn');
    const overlay = document.getElementById('war-overlay');
    let count = 3;
    btn.disabled = true;
    let timer = setInterval(() => {
        btn.innerText = count;
        btn.style.fontSize = "3rem";
        playSound(clickSound);
        count--;
        if(count < 0) {
            clearInterval(timer);
            overlay.style.display = 'none';
            window.warActive = true;
            document.getElementById('war-hint').innerText = "‡∏£‡∏±‡∏ß‡∏ß‡∏ß‡∏ß‡∏ß‡∏ß‡∏ß‡∏ß‡∏ß‡∏ß!!!";
            document.getElementById('war-hint').style.color = "#ffca28";
        }
    }, 800);
}

function tapWar(player) {
    if(!window.warActive) return;
    if(player === 1) window.warScore += 4;
    else window.warScore -= 4;
    
    const p1 = document.getElementById('p1-area');
    const p2 = document.getElementById('p2-area');
    p1.style.flex = window.warScore;
    p2.style.flex = 100 - window.warScore;
    
    document.getElementById('p1-percent').innerText = window.warScore + "%";
    document.getElementById('p2-percent').innerText = (100 - window.warScore) + "%";
    
    playSound(clickSound);

    if(window.warScore >= 100 || window.warScore <= 0) {
        window.warActive = false;
        const winner = window.warScore >= 100 ? "‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô" : "‡πÅ‡∏î‡∏á";
        const winColor = window.warScore >= 100 ? "#2196f3" : "#f44336";
        const loser = window.warScore >= 100 ? "‡πÅ‡∏î‡∏á" : "‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô";
        showWarWinner(winner, winColor, loser);
    }
}

function showWarWinner(winner, color, loser) {
    playSound(resultSound);
    const container = document.getElementById('tap-war-container');
    container.innerHTML = `
        <div style="text-align:center; padding:20px; background:${color}; border-radius:15px; animation: bounce 0.5s infinite alternate;">
            <div style="font-size:3rem; margin-bottom:10px;">üëë</div>
            <div style="font-size:1.8rem; font-weight:800; color:#fff;">‡∏ó‡∏µ‡∏°‡∏™‡∏µ${winner} ‡∏ä‡∏ô‡∏∞!</div>
            <div style="font-size:1.2rem; color:#fff; margin-top:5px;">‡∏™‡∏µ${loser} ‡∏î‡∏∑‡πà‡∏°!</div>
        </div>
        ${getSkipButtonHTML()}
    `;
    resultDisplay.innerText = `‡∏à‡∏ö‡∏®‡∏∂‡∏Å! ‡∏™‡∏µ${winner} ‡πÄ‡∏õ‡πá‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡∏ô‡∏∞`;
    spinBtn.disabled = false;
}

// =================== History ===================
function openHistory() {
    playSound(clickSound); historyModal.classList.add('active');
    if (history.length === 0) { historyListDisplay.innerHTML = '<li style="text-align:center; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</li>'; return; }
    historyListDisplay.innerHTML = history.map(h => `<li class="history-item"><span class="history-tag" style="background:${h.color}">${h.c}</span><span style="flex:1;">${h.t}</span></li>`).join("");
}
function closeHistory() { historyModal.classList.remove('active'); }
historyModal.addEventListener('click', (e) => { if (e.target === historyModal) closeHistory(); });
</script>
    
</body>
</html>
